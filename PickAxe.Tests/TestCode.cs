//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.
//     Runtime Version:4.0.30319.34014
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------

using Pickaxe.Runtime;
using Pickaxe.Runtime.Dom;
using System;
using System.Collections.Generic;
using System.Linq;



public class Code : RuntimeBase
{

    private Scope_d18c866693af4bf790e1ab771616caf2 _Scope_d18c866693af4bf790e1ab771616caf2;

    private Scope_e65069abca6c40bc87a931d47aaf829b _Scope_e65069abca6c40bc87a931d47aaf829b;

    public Code(string[] args) :
        base(args)
    {
        _Scope_d18c866693af4bf790e1ab771616caf2 = new Scope_d18c866693af4bf790e1ab771616caf2();
        _Scope_e65069abca6c40bc87a931d47aaf829b = new Scope_e65069abca6c40bc87a931d47aaf829b();
        TotalOperations = (TotalOperations + 2);
    }

    public void Run()
    {
        InitProxies();
        Block_366598335ed8458d8d235126886847c9();
        Step_d681d994e7f4419fa20a57cebff18a99();
    }

    public void Block_366598335ed8458d8d235126886847c9()
    {
        Step_7bf4c14a3e9f4aad93f087e913a0a297();
        Step_33f9cae88f224ef18641930ee0a39763();
    }

    private CodeTable<anon_78043731f5f34f92a88ffad8e787aab3> From_a3c03791676f4e7ebe31ab2cbbe05cc1()
    {
        Call(9);
        IEnumerable<anon_78043731f5f34f92a88ffad8e787aab3> join = Fetch_78fed019d3e64955ac2764502d47e75d();
        CodeTable<anon_78043731f5f34f92a88ffad8e787aab3> newTable = new CodeTable<anon_78043731f5f34f92a88ffad8e787aab3>();
        newTable.SetRows(join.ToList());
        return newTable;
    }

    private RuntimeTable<DownloadPage> Download_0615cdedec754410955af12cb203a098()
    {
        Call(9);
        return new SelectDownloadTable(Pickaxe.Runtime.LazyDownloadArgs.CreateWebRequestArgs(this, 9, 1, "http://doctor.webmd.com/find-a-doctor/specialties"));
    }

    private IEnumerable<anon_78043731f5f34f92a88ffad8e787aab3> Fetch_78fed019d3e64955ac2764502d47e75d()
    {
        RuntimeTable<DownloadPage> table = Download_0615cdedec754410955af12cb203a098();
        return table.Select(o =>
        {
            return Copy_9851f5e707824ea1a5b6d9b5d5c0f05c(o);
        });
    }

    private anon_78043731f5f34f92a88ffad8e787aab3 Copy_9851f5e707824ea1a5b6d9b5d5c0f05c(DownloadPage o)
    {
        anon_78043731f5f34f92a88ffad8e787aab3 t = new anon_78043731f5f34f92a88ffad8e787aab3();
        t.DownloadPage = o;
        return t;
    }

    private Table<ResultRow> Select_cf310b8823374e25921b9e57b2dd87f7()
    {
        Call(6);
        RuntimeTable<ResultRow> result = new RuntimeTable<ResultRow>();
        result.AddColumn("(No column name)");
        result.AddColumn("a");
        CodeTable<anon_78043731f5f34f92a88ffad8e787aab3> fromTable = From_a3c03791676f4e7ebe31ab2cbbe05cc1();
        fromTable = Where_2ed5f16592f34197969ab115411fd731(fromTable);
        IEnumerator<anon_78043731f5f34f92a88ffad8e787aab3> x = fromTable.GetEnumerator();
        for (
        ; x.MoveNext();
        )
        {
            anon_78043731f5f34f92a88ffad8e787aab3 row = x.Current;
            IEnumerator<HtmlElement> y = row.DownloadPage.nodes.GetEnumerator();
            for (
            ; y.MoveNext();
            )
            {
                HtmlElement node = y.Current;
                ResultRow resultRow = new ResultRow(2);
                resultRow[0] = Pickaxe.Runtime.Helper.NullConcat("http://doctor.webmd.com", node.Pick("a").TakeAttribute("href"));
                resultRow[1] = node.Pick("a").TakeText();
                result.Add(resultRow);
            }
            row.DownloadPage.Clear();
        }
        return result;
    }

    private CodeTable<anon_78043731f5f34f92a88ffad8e787aab3> Where_2ed5f16592f34197969ab115411fd731(CodeTable<anon_78043731f5f34f92a88ffad8e787aab3> table)
    {
        Call(10);
        CodeTable<anon_78043731f5f34f92a88ffad8e787aab3> newTable = new CodeTable<anon_78043731f5f34f92a88ffad8e787aab3>();
        IList<anon_78043731f5f34f92a88ffad8e787aab3> rows = table.Where(row =>
        {
            return row.DownloadPage.CssWhere(ref row.DownloadPage, "section.seo-lists div:nth-child(3) li");
        }).ToList();
        newTable.SetRows(rows);
        return newTable;
    }

    private void Insert_84a6e454241d4fed8b7532a0f9309575()
    {
        Call(5);
        Table<ResultRow> resultRows = Select_cf310b8823374e25921b9e57b2dd87f7();
        _Scope_e65069abca6c40bc87a931d47aaf829b.specialty.BeforeInsert(false);
        _Scope_d18c866693af4bf790e1ab771616caf2.g_identity = _Scope_e65069abca6c40bc87a931d47aaf829b.specialty.RowCount;
        IEnumerator<ResultRow> x = resultRows.GetEnumerator();
        for (
        ; x.MoveNext();
        )
        {
            _Scope_d18c866693af4bf790e1ab771616caf2.g_identity = (_Scope_d18c866693af4bf790e1ab771616caf2.g_identity + 1);
            ResultRow row = x.Current;
            specialty tableRow = new specialty();
            tableRow.id = _Scope_d18c866693af4bf790e1ab771616caf2.g_identity;
            tableRow.url = null;
            if ((row[0] != null))
            {
                tableRow.url = Convert.ToString(row[0]);
            }
            tableRow.spec = null;
            if ((row[1] != null))
            {
                tableRow.spec = Convert.ToString(row[1]);
            }
            _Scope_e65069abca6c40bc87a931d47aaf829b.specialty.Add(tableRow);
        }
        _Scope_e65069abca6c40bc87a931d47aaf829b.specialty.AfterInsert();
    }

    public void Step_7bf4c14a3e9f4aad93f087e913a0a297()
    {
        Insert_84a6e454241d4fed8b7532a0f9309575();
        OnProgress();
    }

    private CodeTable<anon_7760c78b53b04a9dae05f2bcb750f205> From_8d95be5f05b94af4a69b8d457d480890()
    {
        Call(18);
        IEnumerable<anon_3c3f1c8d45574955857b39955b5565f5> join = Fetch_0d1f9e63a26e49cbb0c89b084ecdb9e9();
        return Join_624f8dcd877e4c70b9c28c9f4e42b3b4(join);
    }

    private CodeTable<anon_a260b3d58c0a4ac1b447cb789b903d38> From_1c48a7cde3d44485a658f033895f1308()
    {
        Call(18);
        IEnumerable<anon_a260b3d58c0a4ac1b447cb789b903d38> join = Fetch_31fc7c568a08458c8728524eb1572420();
        CodeTable<anon_a260b3d58c0a4ac1b447cb789b903d38> newTable = new CodeTable<anon_a260b3d58c0a4ac1b447cb789b903d38>();
        newTable.SetRows(join.ToList());
        return newTable;
    }

    private IEnumerable<anon_a260b3d58c0a4ac1b447cb789b903d38> Fetch_31fc7c568a08458c8728524eb1572420()
    {
        CodeTable<specialty> table = _Scope_e65069abca6c40bc87a931d47aaf829b.specialty;
        return table.Select(o =>
        {
            return Copy_ba99b5510dc4436a8880965cb9042a64(o);
        });
    }

    private anon_a260b3d58c0a4ac1b447cb789b903d38 Copy_ba99b5510dc4436a8880965cb9042a64(specialty o)
    {
        anon_a260b3d58c0a4ac1b447cb789b903d38 t = new anon_a260b3d58c0a4ac1b447cb789b903d38();
        t.specialty = o;
        return t;
    }

    private Table<ResultRow> Select_32dfbe9b40204eefb5222bdecc417626()
    {
        Call(18);
        RuntimeTable<ResultRow> result = new RuntimeTable<ResultRow>();
        result.AddColumn("url");
        CodeTable<anon_a260b3d58c0a4ac1b447cb789b903d38> fromTable = From_1c48a7cde3d44485a658f033895f1308();
        IEnumerator<anon_a260b3d58c0a4ac1b447cb789b903d38> x = fromTable.GetEnumerator();
        for (
        ; x.MoveNext();
        )
        {
            anon_a260b3d58c0a4ac1b447cb789b903d38 row = x.Current;
            ResultRow resultRow = new ResultRow(1);
            resultRow[0] = row.specialty.url;
            result.Add(resultRow);
        }
        return result;
    }

    private RuntimeTable<DownloadPage> Download_64a36b7dc84f435a9fb46b1bc819de46()
    {
        Call(18);
        return new SelectDownloadTable(Pickaxe.Runtime.LazyDownloadArgs.CreateWebRequestArgs(this, 18, 4, Select_32dfbe9b40204eefb5222bdecc417626()));
    }

    private IEnumerable<anon_3c3f1c8d45574955857b39955b5565f5> Fetch_0d1f9e63a26e49cbb0c89b084ecdb9e9()
    {
        RuntimeTable<DownloadPage> table = Download_64a36b7dc84f435a9fb46b1bc819de46();
        return table.Select(o =>
        {
            return Copy_8cb662ceb923448ebfa637fd90910d73(o);
        });
    }

    private anon_3c3f1c8d45574955857b39955b5565f5 Copy_8cb662ceb923448ebfa637fd90910d73(DownloadPage o)
    {
        anon_3c3f1c8d45574955857b39955b5565f5 t = new anon_3c3f1c8d45574955857b39955b5565f5();
        t.d = o;
        return t;
    }

    private CodeTable<anon_7760c78b53b04a9dae05f2bcb750f205> Join_624f8dcd877e4c70b9c28c9f4e42b3b4(IEnumerable<anon_3c3f1c8d45574955857b39955b5565f5> outer)
    {
        Call(19);
        IEnumerable<anon_198f26b7905c4bada7d550940534b415> table = Fetch_5b6da73f0a554ca9bb7dac48b9bdfbae();
        IList<anon_7760c78b53b04a9dae05f2bcb750f205> join = new List<anon_7760c78b53b04a9dae05f2bcb750f205>();
        IEnumerator<anon_3c3f1c8d45574955857b39955b5565f5> o = outer.GetEnumerator();
        for (
        ; o.MoveNext();
        )
        {
            anon_3c3f1c8d45574955857b39955b5565f5 oc = o.Current;
            IEnumerator<anon_198f26b7905c4bada7d550940534b415> i = table.GetEnumerator();
            for (
            ; i.MoveNext();
            )
            {
                anon_198f26b7905c4bada7d550940534b415 ic = i.Current;
                if (((ic.s.url == oc.d.url)
            && oc.d.CssWhere(ref oc.d, "div.states li")))
                {
                    anon_7760c78b53b04a9dae05f2bcb750f205 t = new anon_7760c78b53b04a9dae05f2bcb750f205();
                    t.d = oc.d;
                    t.s = ic.s;
                    join.Add(t);
                }
            }
        }
        CodeTable<anon_7760c78b53b04a9dae05f2bcb750f205> newTable = new CodeTable<anon_7760c78b53b04a9dae05f2bcb750f205>();
        newTable.SetRows(join.ToList());
        return newTable;
    }

    private IEnumerable<anon_198f26b7905c4bada7d550940534b415> Fetch_5b6da73f0a554ca9bb7dac48b9bdfbae()
    {
        CodeTable<specialty> table = _Scope_e65069abca6c40bc87a931d47aaf829b.specialty;
        return table.Select(o =>
        {
            return Copy_50b22c358adc45b2a4b2b4b2654243be(o);
        });
    }

    private anon_198f26b7905c4bada7d550940534b415 Copy_50b22c358adc45b2a4b2b4b2654243be(specialty o)
    {
        anon_198f26b7905c4bada7d550940534b415 t = new anon_198f26b7905c4bada7d550940534b415();
        t.s = o;
        return t;
    }

    private Table<ResultRow> Select_fb982a63e33340a281868f3dbf9186b1()
    {
        Call(14);
        RuntimeTable<ResultRow> result = new RuntimeTable<ResultRow>();
        result.AddColumn("(No column name)");
        result.AddColumn("url");
        result.AddColumn("spec");
        CodeTable<anon_7760c78b53b04a9dae05f2bcb750f205> fromTable = From_8d95be5f05b94af4a69b8d457d480890();
        IEnumerator<anon_7760c78b53b04a9dae05f2bcb750f205> x = fromTable.GetEnumerator();
        for (
        ; x.MoveNext();
        )
        {
            anon_7760c78b53b04a9dae05f2bcb750f205 row = x.Current;
            IEnumerator<HtmlElement> y = row.d.nodes.GetEnumerator();
            for (
            ; y.MoveNext();
            )
            {
                HtmlElement node = y.Current;
                ResultRow resultRow = new ResultRow(3);
                resultRow[0] = Pickaxe.Runtime.Helper.NullConcat("http://doctor.webmd.com", node.Pick("a").TakeAttribute("href"));
                resultRow[1] = row.d.url;
                resultRow[2] = row.s.spec;
                result.Add(resultRow);
            }
            row.d.Clear();
        }
        OnSelect(result);
        return result;
    }

    public void Step_33f9cae88f224ef18641930ee0a39763()
    {
        Select_fb982a63e33340a281868f3dbf9186b1();
        OnProgress();
    }

    public void Step_d681d994e7f4419fa20a57cebff18a99()
    {
        OnProgress(new ProgressArgs(TotalOperations, TotalOperations));
    }

    private class Scope_d18c866693af4bf790e1ab771616caf2
    {

        public int g_identity;

        public Scope_d18c866693af4bf790e1ab771616caf2()
        {
        }
    }

    private class Scope_e65069abca6c40bc87a931d47aaf829b
    {

        public CodeTable<specialty> specialty;

        public Scope_e65069abca6c40bc87a931d47aaf829b()
        {
            specialty = new BufferTable<specialty>();
        }
    }

    private class specialty : IRow
    {

        public System.Nullable<int> id;

        public string url;

        public string spec;
    }

    private class anon_78043731f5f34f92a88ffad8e787aab3 : IRow
    {

        public DownloadPage DownloadPage;
    }

    private class anon_a260b3d58c0a4ac1b447cb789b903d38 : IRow
    {

        public specialty specialty;
    }

    private class anon_3c3f1c8d45574955857b39955b5565f5 : IRow
    {

        public DownloadPage d;
    }

    private class anon_198f26b7905c4bada7d550940534b415 : IRow
    {

        public specialty s;
    }

    private class anon_7760c78b53b04a9dae05f2bcb750f205 : IRow
    {

        public DownloadPage d;

        public specialty s;
    }
}
